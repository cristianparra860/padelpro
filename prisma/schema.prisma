generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  SUPER_ADMIN
  CLUB_ADMIN
  INSTRUCTOR
  PLAYER
}

model Admin {
  id        String   @id
  email     String   @unique
  name      String
  role      String   @default("CLUB_ADMIN")
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime
  Club      Club[]
}

model Booking {
  id                  String   @id
  userId              String
  timeSlotId          String
  groupSize           Int      @default(1)
  status              String   @default("CONFIRMED")
  wasConfirmed        Boolean  @default(false)
  paidWithPoints      Boolean  @default(false)
  paymentMethod       String   @default("CREDITS")
  pointsUsed          Int      @default(0)
  amountBlocked       Int      @default(0)
  isRecycled          Boolean  @default(false)
  isInstructorSubsidy Boolean  @default(false)
  hiddenFromHistory   Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime
  TimeSlot            TimeSlot @relation(fields: [timeSlotId], references: [id])
  User                User     @relation(fields: [userId], references: [id])

  @@index([userId, status])
  @@index([timeSlotId, status])
}

model Club {
  id               String           @id
  name             String
  address          String
  phone            String?
  email            String?
  website          String?
  logo             String?
  description      String?
  courtRentalPrice Float            @default(10.0)
  adminId          String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  openingHours     String?
  heroImage        String?
  Admin            Admin?           @relation(fields: [adminId], references: [id])
  ClubSchedule     ClubSchedule[]
  Court            Court[]
  CourtPriceSlot   CourtPriceSlot[]
  Instructor       Instructor[]
  Match            Match[]
  MatchGame        MatchGame[]
  TimeSlot         TimeSlot[]
  User             User[]
}

model ClubSchedule {
  id        String   @id
  clubId    String
  dayOfWeek Int
  openTime  String
  closeTime String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime
  Club      Club     @relation(fields: [clubId], references: [id])

  @@unique([clubId, dayOfWeek])
}

model Court {
  id            String          @id
  number        Int
  name          String?
  capacity      Int             @default(4)
  clubId        String
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  Club          Club            @relation(fields: [clubId], references: [id])
  CourtSchedule CourtSchedule[]
  Match         Match[]
  MatchGame     MatchGame[]
  TimeSlot      TimeSlot[]

  @@unique([clubId, number])
}

model CourtPriceSlot {
  id         String   @id
  clubId     String
  name       String
  startTime  String
  endTime    String
  price      Float
  daysOfWeek String
  isActive   Boolean  @default(true)
  priority   Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  Club       Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
}

model CourtSchedule {
  id         String   @id
  courtId    String
  date       DateTime
  startTime  DateTime
  endTime    DateTime
  isOccupied Boolean  @default(false)
  timeSlotId String?
  reason     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  Court      Court    @relation(fields: [courtId], references: [id])

  @@unique([courtId, startTime])
}

model ImpersonationLog {
  id              String    @id
  superAdminId    String
  superAdminEmail String
  targetUserId    String
  targetUserEmail String
  targetUserRole  String
  startedAt       DateTime  @default(now())
  endedAt         DateTime?
  durationMinutes Int?
  ipAddress       String?
  userAgent       String?
  reason          String?

  @@index([startedAt])
  @@index([targetUserId])
  @@index([superAdminId])
}

model Instructor {
  id                     String                   @id
  userId                 String                   @unique
  name                   String
  specialties            String?
  experience             String?
  profilePictureUrl      String?
  hourlyRate             Float?
  clubId                 String
  isActive               Boolean                  @default(true)
  isAvailable            Boolean                  @default(true)
  defaultRatePerHour     Float?
  rateTiers              String?
  levelRanges            String?
  unavailableHours       String?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  Club                   Club                     @relation(fields: [clubId], references: [id])
  User                   User                     @relation(fields: [userId], references: [id])
  InstructorAvailability InstructorAvailability[]
  InstructorRestriction  InstructorRestriction[]
  InstructorSchedule     InstructorSchedule[]
  TimeSlot               TimeSlot[]
}

model InstructorAvailability {
  id           String     @id
  instructorId String
  dayOfWeek    Int
  startTime    String
  endTime      String
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime
  Instructor   Instructor @relation(fields: [instructorId], references: [id])

  @@unique([instructorId, dayOfWeek, startTime])
}

model InstructorRestriction {
  id           String     @id
  instructorId String
  date         DateTime
  startTime    String?
  endTime      String?
  reason       String?
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime
  Instructor   Instructor @relation(fields: [instructorId], references: [id])
}

model InstructorSchedule {
  id           String     @id
  instructorId String
  date         DateTime
  startTime    DateTime
  endTime      DateTime
  isOccupied   Boolean    @default(false)
  timeSlotId   String?
  reason       String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime
  Instructor   Instructor @relation(fields: [instructorId], references: [id])

  @@unique([instructorId, startTime])
}

model Match {
  id          String        @id
  clubId      String
  courtId     String
  startTime   DateTime
  endTime     DateTime
  type        String        @default("CASUAL")
  status      String        @default("SCHEDULED")
  isPrivate   Boolean       @default(false)
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime
  Court       Court         @relation(fields: [courtId], references: [id])
  Club        Club          @relation(fields: [clubId], references: [id])
  MatchPlayer MatchPlayer[]
}

model MatchGame {
  id                      String             @id
  clubId                  String
  courtId                 String?
  courtNumber             Int?
  start                   DateTime
  end                     DateTime
  duration                Int                @default(60)
  maxPlayers              Int                @default(4)
  courtRentalPrice        Float              @default(0)
  pricePerPlayer          Float              @default(0)
  level                   String?
  genderCategory          String?
  isOpen                  Boolean            @default(true)
  hasRecycledSlots        Boolean            @default(false)
  availableRecycledSlots  Int?
  recycledSlotsOnlyPoints Boolean            @default(true)
  creditsSlots            String?
  creditsCost             Int                @default(50)
  createdAt               DateTime           @default(now())
  updatedAt               DateTime
  Court                   Court?             @relation(fields: [courtId], references: [id])
  Club                    Club               @relation(fields: [clubId], references: [id])
  MatchGameBooking        MatchGameBooking[]

  @@index([start, courtNumber])
  @@index([start, clubId])
}

model MatchGameBooking {
  id                String    @id
  userId            String
  matchGameId       String
  status            String    @default("PENDING")
  wasConfirmed      Boolean   @default(false)
  paidWithPoints    Boolean   @default(false)
  paymentMethod     String    @default("CREDITS")
  pointsUsed        Int       @default(0)
  amountBlocked     Int       @default(0)
  groupSize         Int       @default(1)
  isRecycled        Boolean   @default(false)
  hiddenFromHistory Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime
  MatchGame         MatchGame @relation(fields: [matchGameId], references: [id])
  User              User      @relation(fields: [userId], references: [id])
}

model MatchPlayer {
  id       String  @id
  matchId  String
  userId   String
  position String?
  score    Int?
  User     User    @relation(fields: [userId], references: [id])
  Match    Match   @relation(fields: [matchId], references: [id])

  @@unique([matchId, userId])
}

model QRSession {
  id        String   @id
  token     String   @unique
  status    String   @default("pending")
  userId    String?
  authToken String?
  clubId    String?
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([expiresAt])
  @@index([status])
  @@index([token])
}

model TimeSlot {
  id                      String      @id
  clubId                  String
  courtId                 String?
  courtNumber             Int?
  instructorId            String?
  start                   DateTime
  end                     DateTime
  maxPlayers              Int         @default(4)
  instructorPrice         Float       @default(0)
  courtRentalPrice        Float       @default(0)
  totalPrice              Float
  level                   String
  category                String
  genderCategory          String?
  levelRange              String?
  hasRecycledSlots        Boolean     @default(false)
  availableRecycledSlots  Int?
  recycledSlotsOnlyPoints Boolean     @default(true)
  creditsSlots            String?
  creditsCost             Int         @default(50)
  createdAt               DateTime    @default(now())
  updatedAt               DateTime
  Booking                 Booking[]
  Instructor              Instructor? @relation(fields: [instructorId], references: [id])
  Court                   Court?      @relation(fields: [courtId], references: [id])
  Club                    Club        @relation(fields: [clubId], references: [id])

  @@index([instructorId, start])
  @@index([start, courtId])
  @@index([start, clubId])
}

model Transaction {
  id          String   @id
  userId      String
  type        String
  action      String
  amount      Float
  balance     Float
  concept     String
  relatedId   String?
  relatedType String?
  metadata    String?
  createdAt   DateTime @default(now())
  User        User     @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([userId])
}

model User {
  id                String             @id
  email             String             @unique
  name              String
  password          String?
  profilePictureUrl String?
  phone             String?
  level             String             @default("principiante")
  position          String?
  gender            String?
  clubId            String
  role              Role               @default(PLAYER)
  preference        String             @default("NORMAL")
  visibility        String             @default("PUBLIC")
  bio               String?
  credits           Int                @default(0)
  blockedCredits    Int                @default(0)
  points            Int                @default(0)
  blockedPoints     Int                @default(0)
  genderCategory    String?
  preferredGameType String?
  prefTimeSlot      String?            @default("all")
  prefViewType      String?            @default("all")
  prefPlayerCounts  String?            @default("1,2,3,4")
  prefInstructorIds String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime
  Booking           Booking[]
  Instructor        Instructor?
  MatchGameBooking  MatchGameBooking[]
  MatchPlayer       MatchPlayer[]
  Transaction       Transaction[]
  Club              Club               @relation(fields: [clubId], references: [id])
}
